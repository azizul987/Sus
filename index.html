<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekap SUS</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f6fa;
      color: #222;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 24px;
    }
    h2 {
      margin: 16px 0 8px;
      font-size: 18px;
    }
    .subtitle {
      margin: 0 0 16px;
      color: #666;
      font-size: 13px;
    }
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e2e8f0;
      padding: 3px;
      margin-bottom: 16px;
      gap: 4px;
    }
    .tab-btn {
      border: none;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      background: transparent;
      cursor: pointer;
      color: #475569;
    }
    .tab-btn.active {
      background: #fff;
      box-shadow: 0 1px 3px rgba(15,23,42,0.2);
      color: #0f172a;
      font-weight: 600;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .search-input,
    .select-input {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      font-size: 13px;
      background: #fff;
    }
    .search-input {
      min-width: 220px;
    }
    .select-input {
      min-width: 200px;
    }
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      padding: 16px 16px 8px;
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }
    thead {
      background: #f1f5f9;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #f8fafc;
    }
    tbody tr:hover {
      background: #e2f3ff;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-ok {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }
    .badge-warn {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #facc15;
    }
    .apps-list {
      font-size: 11px;
      color: #444;
    }
    .apps-list span {
      display: inline-block;
      margin-right: 6px;
      margin-bottom: 2px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: #777;
    }
    .small {
      font-size: 11px;
      color: #666;
    }
    .sus-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .sus-metrics div {
      padding: 6px 10px;
      border-radius: 8px;
      background: #f1f5f9;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Rekap SUS</h1>
    <p class="subtitle">
      Ringkasan jumlah pengisian form SUS, status penilaian tiap pembuat, dan skor SUS per aplikasi.
      <span id="last-update"></span>
    </p>

    <!-- TAB MENU -->
    <div class="tabs">
      <button class="tab-btn active" id="tab-main">Rekap Aplikasi</button>
      <button class="tab-btn" id="tab-sus">Detail SUS</button>
    </div>

    <!-- ========== SECTION 1: REKAP APLIKASI ========== -->
    <div id="section-main">
      <div class="toolbar">
        <input
          id="search"
          class="search-input"
          type="text"
          placeholder="Cari nama / NIM / aplikasi..."
        />

        <select id="filter-app" class="select-input">
          <option value="">Filter berdasarkan aplikasi yang belum dinilai...</option>
        </select>

        <label class="checkbox-label">
          <input type="checkbox" id="only-pending" />
          Tampilkan hanya yang masih punya aplikasi belum dinilai
        </label>
      </div>

      <!-- TABEL UTAMA -->
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama</th>
              <th>NIM</th>
              <th>Aplikasi</th>
              <th>Jumlah Isi</th>
              <th>Jumlah Terisi</th>
              <th>Status Penilaian</th>
              <th>Belum Menilai Aplikasi</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="8">Memuat data...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- TABEL NIM BERMASALAH -->
      <h2>Responden dengan NIM tidak konsisten</h2>
      <p class="small">
        Daftar nama responden yang menggunakan lebih dari satu NIM berbeda ketika mengisi form SUS.
      </p>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama Responden</th>
              <th>Detail NIM yang dipakai</th>
            </tr>
          </thead>
          <tbody id="tbody-nim">
            <tr>
              <td colspan="3">Memuat data NIM...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ========== SECTION 2: DETAIL SUS PER APLIKASI ========== -->
    <div id="section-sus" class="hidden">
      <h2>Detail SUS per Aplikasi</h2>
      <p class="small">
        Pilih aplikasi untuk melihat pemilik, rata-rata skor SUS, dan siapa saja yang mengisi beserta detail jawabannya.
      </p>

      <div class="toolbar">
        <select id="sus-app-select" class="select-input">
          <option value="">Pilih aplikasi...</option>
        </select>
      </div>

      <div class="card">
        <div class="sus-metrics" id="sus-metrics">
          <!-- akan diisi via JS -->
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama Responden</th>
              <th>NIM</th>
              <th>Q1</th>
              <th>Q2</th>
              <th>Q3</th>
              <th>Q4</th>
              <th>Q5</th>
              <th>Q6</th>
              <th>Q7</th>
              <th>Q8</th>
              <th>Q9</th>
              <th>Q10</th>
              <th>Jumlah</th>
              <th>SUS Score</th>
            </tr>
          </thead>
          <tbody id="sus-tbody">
            <tr>
              <td colspan="15">Pilih aplikasi untuk melihat daftar responden.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="footer-note">
      Data diambil dari Google Spreadsheet dan diperbarui otomatis oleh GitHub Actions.
    </p>
  </div>

  <script>
    let globalData = [];
    let nimIssues = [];
    let susData = [];

    // ====== RENDER REKAP APLIKASI ======
    function renderTable() {
      const tbody = document.getElementById("tbody");
      const search = document.getElementById("search").value.toLowerCase().trim();
      const onlyPending = document.getElementById("only-pending").checked;
      const filterApp = document.getElementById("filter-app").value;

      tbody.innerHTML = "";

      const filtered = globalData.filter((d) => {
        const text =
          (d.name || "") +
          " " +
          (d.nim || "") +
          " " +
          (d.app || "");
        const matchesSearch = text.toLowerCase().includes(search);

        const notFilled = d.not_filled || [];
        const pending = notFilled.length > 0;
        const matchesPending = !onlyPending || pending;

        const matchesApp =
          !filterApp || notFilled.includes(filterApp);

        return matchesSearch && matchesPending && matchesApp;
      });

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8">Tidak ada data untuk filter saat ini.</td>`;
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach((d, index) => {
        const notFilled = d.not_filled || [];
        const pending = notFilled.length > 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${d.name || "-"}</td>
          <td>${d.nim || "-"}</td>
          <td>${d.app || "-"}</td>
          <td>${d.filled ?? 0}</td>
          <td>${d.app_filled_count ?? 0}</td>
          <td>
            ${
              pending
                ? `<span class="badge badge-warn">${notFilled.length} aplikasi belum dinilai</span>`
                : `<span class="badge badge-ok">Sudah menilai semua</span>`
            }
          </td>
          <td>
            ${
              pending
                ? `<div class="apps-list">
                     ${notFilled.map((app) => `<span>${app}</span>`).join("")}
                   </div>`
                : "-"
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderNimIssues() {
      const tbody = document.getElementById("tbody-nim");
      tbody.innerHTML = "";

      if (!Array.isArray(nimIssues) || nimIssues.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3">Tidak ada nama dengan NIM tidak konsisten.</td>`;
        tbody.appendChild(tr);
        return;
      }

      nimIssues.forEach((row, index) => {
        const nims = row.nims || [];
        const counts = row.nim_counts || {};
        const detail = nims
          .map((nim) => `${nim} (${counts[nim] ?? 0}x)`)
          .join(", ");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${row.name || "-"}</td>
          <td>${detail}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== FORMAT LAST-UPDATE DALAM WIB ======
    function setLastUpdate() {
    const el = document.getElementById("last-update");

    fetch("data.json?" + Date.now())
      .then(r => r.json())
      .then(data => {
        if (!data || data.length === 0) return;
        const ts = data[0].generated_at;

        const dateUTC = new Date(ts);
        const dateWIB = new Date(dateUTC.getTime() + 7 * 3600 * 1000);

        const bulan = [
          "Januari","Februari","Maret","April","Mei","Juni",
          "Juli","Agustus","September","Oktober","November","Desember"
        ];

        const tgl = dateWIB.getDate();
        const bln = bulan[dateWIB.getMonth()];
        const thn = dateWIB.getFullYear();
        const jam = String(dateWIB.getHours()).padStart(2, "0");
        const menit = String(dateWIB.getMinutes()).padStart(2, "0");

        el.textContent = ` â€¢ Terakhir diperbarui: ${tgl} ${bln} ${thn} ${jam}:${menit} WIB`;
      });
  }

    function populateAppFilter() {
      const select = document.getElementById("filter-app");
      const appSet = new Set();
      globalData.forEach((d) => {
        (d.not_filled || []).forEach((app) => appSet.add(app));
      });
      const apps = Array.from(appSet).sort();

      select.innerHTML = `<option value="">Filter berdasarkan aplikasi yang belum dinilai...</option>`;
      apps.forEach((app) => {
        const opt = document.createElement("option");
        opt.value = app;
        opt.textContent = app;
        select.appendChild(opt);
      });
    }

    // ====== RENDER DETAIL SUS ======
    function populateSusAppSelect() {
      const select = document.getElementById("sus-app-select");
      if (!Array.isArray(susData) || susData.length === 0) {
        select.innerHTML = `<option value="">Belum ada data SUS (sus_scores.json kosong).</option>`;
        return;
      }
      const apps = susData
        .map((d) => d.app)
        .filter((v, i, arr) => v && arr.indexOf(v) === i)
        .sort();

      select.innerHTML = `<option value="">Pilih aplikasi...</option>`;
      apps.forEach((app) => {
        const opt = document.createElement("option");
        opt.value = app;
        opt.textContent = app;
        select.appendChild(opt);
      });
    }

    function renderSusDetail() {
      const select = document.getElementById("sus-app-select");
      const appName = select.value;
      const tbody = document.getElementById("sus-tbody");
      const metrics = document.getElementById("sus-metrics");

      tbody.innerHTML = "";
      metrics.innerHTML = "";

      if (!appName) {
        tbody.innerHTML = `<tr><td colspan="15">Pilih aplikasi untuk melihat daftar responden.</td></tr>`;
        return;
      }

      const entry = susData.find((d) => d.app === appName);
      if (!entry) {
        tbody.innerHTML = `<tr><td colspan="15">Data SUS untuk aplikasi ini tidak ditemukan.</td></tr>`;
        return;
      }

      const ownerName = entry.owner_name || "-";
      const ownerNim = entry.owner_nim || "-";
      const avg = entry.avg_sus != null ? entry.avg_sus.toFixed(1) : "-";
      const count = entry.count ?? (entry.responses ? entry.responses.length : 0);

      metrics.innerHTML = `
        <div><strong>Aplikasi:</strong> ${entry.app}</div>
        <div><strong>Pembuat:</strong> ${ownerName} (${ownerNim})</div>
        <div><strong>Rata-rata SUS:</strong> ${avg}</div>
        <div><strong>Jumlah responden:</strong> ${count}</div>
      `;

      const responses = entry.responses || [];
      if (responses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="15">Belum ada respon SUS untuk aplikasi ini.</td></tr>`;
        return;
      }

      responses.forEach((r, index) => {
        const score = r.sus != null ? r.sus.toFixed(1) : "-";
        const jumlah = r.jumlah != null ? r.jumlah : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${r.respondent_name || "-"}</td>
          <td>${r.respondent_nim || "-"}</td>
          <td>${r.q1 ?? "-"}</td>
          <td>${r.q2 ?? "-"}</td>
          <td>${r.q3 ?? "-"}</td>
          <td>${r.q4 ?? "-"}</td>
          <td>${r.q5 ?? "-"}</td>
          <td>${r.q6 ?? "-"}</td>
          <td>${r.q7 ?? "-"}</td>
          <td>${r.q8 ?? "-"}</td>
          <td>${r.q9 ?? "-"}</td>
          <td>${r.q10 ?? "-"}</td>
          <td>${jumlah}</td>
          <td>${score}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== TAB SWITCHING ======
    function switchTab(tab) {
      const main = document.getElementById("section-main");
      const sus = document.getElementById("section-sus");
      const btnMain = document.getElementById("tab-main");
      const btnSus = document.getElementById("tab-sus");

      if (tab === "main") {
        main.classList.remove("hidden");
        sus.classList.add("hidden");
        btnMain.classList.add("active");
        btnSus.classList.remove("active");
      } else {
        main.classList.add("hidden");
        sus.classList.remove("hidden");
        btnMain.classList.remove("active");
        btnSus.classList.add("active");
      }
    }

    document.getElementById("tab-main").addEventListener("click", () => switchTab("main"));
    document.getElementById("tab-sus").addEventListener("click", () => switchTab("sus"));

    // ====== FETCH DATA ======
    // data utama
    fetch("data.json?" + Date.now())
      .then((r) => {
        if (!r.ok) throw new Error("Gagal fetch data.json: status " + r.status);
        return r.json();
      })
      .then((data) => {
        if (!Array.isArray(data)) throw new Error("Format data.json tidak sesuai (bukan array).");
        globalData = data;
        populateAppFilter();
        renderTable();
        setLastUpdate();
      })
      .catch((err) => {
        console.error(err);
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = `<tr><td colspan="8">Error memuat data: ${err.message}</td></tr>`;
      });

    // nim_issues
    fetch("nim_issues.json?" + Date.now())
      .then((r) => {
        if (!r.ok) throw new Error("nim_issues.json tidak ditemukan");
        return r.json();
      })
      .then((data) => {
        nimIssues = Array.isArray(data) ? data : [];
        renderNimIssues();
      })
      .catch((err) => {
        console.warn(err.message);
        const tbody = document.getElementById("tbody-nim");
        tbody.innerHTML = `<tr><td colspan="3">Tidak ada data NIM bermasalah atau nim_issues.json belum dibuat.</td></tr>`;
      });

    // sus_scores (untuk tab SUS)
    fetch("sus_scores.json?" + Date.now())
      .then((r) => {
        if (!r.ok) throw new Error("sus_scores.json tidak ditemukan");
        return r.json();
      })
      .then((data) => {
        susData = Array.isArray(data) ? data : [];
        populateSusAppSelect();
      })
      .catch((err) => {
        console.warn(err.message);
        const select = document.getElementById("sus-app-select");
        select.innerHTML = `<option value="">sus_scores.json belum tersedia.</option>`;
      });

    // event listeners
    document.getElementById("search").addEventListener("input", renderTable);
    document.getElementById("only-pending").addEventListener("change", renderTable);
    document.getElementById("filter-app").addEventListener("change", renderTable);
    document.getElementById("sus-app-select").addEventListener("change", renderSusDetail);
  </script>
</body>
</html>
