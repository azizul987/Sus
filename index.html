<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap SUS</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; 
      padding: 0;
      background: var(--bg-body);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.025em;
      color: #111827;
    }

    h2 {
      margin: 32px 0 16px;
      font-size: 20px;
      font-weight: 600;
      color: #374151;
    }

    .subtitle {
      margin: 0 0 32px;
      color: var(--text-muted);
      font-size: 16px;
    }

    /* Tabs */
    .tabs {
      display: inline-flex;
      background: #e5e7eb;
      padding: 4px;
      border-radius: 99px;
      margin-bottom: 24px;
    }

    .tab-btn {
      border: none;
      padding: 8px 20px;
      border-radius: 99px;
      font-size: 14px;
      font-weight: 500;
      background: transparent;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #374151;
    }

    .tab-btn.active {
      background: #fff;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 600;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      background: var(--bg-card);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .search-input,
    .select-input {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #fff;
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s;
    }

    .search-input:focus,
    .select-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .search-input { min-width: 240px; }

    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
      color: #4b5563;
      user-select: none;
    }

    /* Card & Table */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden; /* for border radius on table */
      border: 1px solid var(--border);
      margin-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
      text-align: left;
    }

    thead {
      background: #f9fafb;
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 12px 16px;
      font-weight: 600;
      color: #4b5563;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      color: #374151;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      line-height: 1.6;
    }

    .badge-ok {
      background: #dcfce7;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .badge-warn {
      background: #fef3c7;
      color: #b45309;
      border: 1px solid #fde68a;
    }

    .app-tag {
      display: inline-flex;
      align-items: center;
      background: #fff;
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      color: #4b5563;
      margin-right: 6px;
      margin-bottom: 6px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      white-space: nowrap;
    }
    
    .app-tag:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .hidden { display: none !important; }

    /* SUS Metrics */
    .sus-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .sus-metrics div {
      padding: 16px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .sus-metrics div strong {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    /* Responsive Table */
    .card {
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <div class="page">
    <h1>Rekap SUS</h1>
    <p class="subtitle">
      Ringkasan hasil SUS dan evaluasi aplikasi.
      <span id="last-update"></span>
    </p>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" id="tab-main">Rekap Aplikasi</button>
      <button class="tab-btn" id="tab-sus">Detail SUS</button>
    </div>

    <!-- ============================================================= -->
    <!-- SECTION 1: REKAP APLIKASI -->
    <!-- ============================================================= -->
    <div id="section-main">
      <div class="toolbar">
        <input id="search" class="search-input" placeholder="Cari nama / NIM / aplikasi..." />

        <select id="filter-app" class="select-input">
          <option value="">Filter berdasarkan aplikasi...</option>
        </select>

        <label class="checkbox-label">
          <input type="checkbox" id="only-pending" />
          Hanya yang belum menilai semua
        </label>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama</th>
              <th>NIM</th>
              <th>Aplikasi</th>
              <th>Jumlah Isi</th>
              <th>Jumlah Terisi</th>
              <th>Status</th>
              <th>Belum Menilai</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>

      <h2>NIM Bermasalah</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama</th>
              <th>Detail NIM</th>
            </tr>
          </thead>
          <tbody id="tbody-nim">
            <tr><td colspan="3">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ============================================================= -->
    <!-- SECTION 2: DETAIL SUS -->
    <!-- ============================================================= -->
    <div id="section-sus" class="hidden">
      <h2>Detail SUS per Aplikasi</h2>

      <div class="toolbar">
        <select id="sus-app-select" class="select-input">
          <option value="">Pilih aplikasi...</option>
        </select>
      </div>

      <div class="card">
        <div class="sus-metrics" id="sus-metrics"></div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Nama</th>
              <th>NIM</th>

              <th colspan="10">Jawaban Q1–Q10</th>
              <th colspan="10">Skor S1–S10</th>

              <th>Jumlah</th>
              <th>SUS</th>
            </tr>

            <tr>
              <th></th><th></th><th></th>

              <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th>
              <th>Q6</th><th>Q7</th><th>Q8</th><th>Q9</th><th>Q10</th>

              <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th>
              <th>S6</th><th>S7</th><th>S8</th><th>S9</th><th>S10</th>

              <th></th>
              <th></th>
            </tr>
          </thead>

          <tbody id="sus-tbody">
            <tr><td colspan="25">Pilih aplikasi.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <p style="font-size:11px;color:#666;margin-top:12px;">
      Data diperbarui otomatis oleh GitHub Actions.
    </p>

  </div>

<script>
let globalData = [];
let nimIssues = [];
let susData = [];

/* ==========================================
      FORMAT WAKTU DARI generated_at (UTC)
========================================== */
function setLastUpdate() {
  const el = document.getElementById("last-update");

  fetch("data.json?" + Date.now())
    .then(r => r.json())
    .then(js => {
      if (!Array.isArray(js) || js.length === 0) return;
      const utc = new Date(js[0].generated_at);
      const wib = new Date(utc.getTime() + 7 * 3600 * 1000);

      const bulan = [
        "Januari","Februari","Maret","April","Mei","Juni",
        "Juli","Agustus","September","Oktober","November","Desember"
      ];

      const t = wib.getDate();
      const b = bulan[wib.getMonth()];
      const y = wib.getFullYear();
      const h = String(wib.getHours()).padStart(2, "0");
      const m = String(wib.getMinutes()).padStart(2, "0");

      el.textContent = ` • Terakhir diperbarui: ${t} ${b} ${y} ${h}:${m} WIB`;
    });
}

/* ==========================================
           RENDER TABEL REKAP
========================================== */
function renderTable() {
  const tbody = document.getElementById("tbody");
  const search = document.getElementById("search").value.toLowerCase();
  const onlyPending = document.getElementById("only-pending").checked;
  const filterApp = document.getElementById("filter-app").value;

  tbody.innerHTML = "";

  const filtered = globalData.filter(d => {
    const text = `${d.name} ${d.nim} ${d.app}`.toLowerCase();
    const matchText = text.includes(search);

    const pending = (d.not_filled || []).length > 0;
    const matchPending = !onlyPending || pending;

    const matchApp = !filterApp || (d.not_filled || []).includes(filterApp);

    return matchText && matchPending && matchApp;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8">Tidak ada data.</td></tr>`;
    return;
  }

  filtered.forEach((d,i) => {
    const pending = (d.not_filled || []).length > 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${d.name}</td>
      <td>${d.nim}</td>
      <td>${d.app}</td>
      <td>${d.filled}</td>
      <td>${d.app_filled_count}</td>
      <td>${pending ? `<span class='badge badge-warn'>${d.not_filled.length} belum</span>` : `<span class='badge badge-ok'>Lengkap</span>`}</td>
      <td>${pending ? d.not_filled.map(a=>`<span class='app-tag'>${a}</span>`).join("") : "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==========================================
      RENDER NIM ISSUES
========================================== */
function renderNimIssues() {
  const tbody = document.getElementById("tbody-nim");
  tbody.innerHTML = "";

  if (!nimIssues.length) {
    tbody.innerHTML = `<tr><td colspan="3">Tidak ada NIM bermasalah.</td></tr>`;
    return;
  }

  nimIssues.forEach((r,i) => {
    const detail = r.nims.map(n => `${n} (${r.nim_counts[n]}x)`).join(", ");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${detail}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==========================================
      DETAIL SUS (TABEL BESAR)
========================================== */
function renderSusDetail() {
  const appName = document.getElementById("sus-app-select").value;
  const tbody = document.getElementById("sus-tbody");
  const metrics = document.getElementById("sus-metrics");

  tbody.innerHTML = "";
  metrics.innerHTML = "";

  if (!appName) {
    tbody.innerHTML = `<tr><td colspan="25">Pilih aplikasi.</td></tr>`;
    return;
  }

  const entry = susData.find(x => x.app === appName);
  if (!entry) {
    tbody.innerHTML = `<tr><td colspan="25">Data tidak ditemukan.</td></tr>`;
    return;
  }

  metrics.innerHTML = `
    <div><strong>Aplikasi:</strong> ${entry.app}</div>
    <div><strong>Pembuat:</strong> ${entry.owner_name} (${entry.owner_nim})</div>
    <div><strong>Rata-rata SUS:</strong> ${entry.avg_sus.toFixed(1)}</div>
    <div><strong>Jumlah responden:</strong> ${entry.count}</div>
  `;

  entry.responses.forEach((r,i) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.respondent_name}</td>
      <td>${r.respondent_nim}</td>

      <td>${r.q1 ?? "-"}</td>
      <td>${r.q2 ?? "-"}</td>
      <td>${r.q3 ?? "-"}</td>
      <td>${r.q4 ?? "-"}</td>
      <td>${r.q5 ?? "-"}</td>
      <td>${r.q6 ?? "-"}</td>
      <td>${r.q7 ?? "-"}</td>
      <td>${r.q8 ?? "-"}</td>
      <td>${r.q9 ?? "-"}</td>
      <td>${r.q10 ?? "-"}</td>

      <td>${r.s1 ?? "-"}</td>
      <td>${r.s2 ?? "-"}</td>
      <td>${r.s3 ?? "-"}</td>
      <td>${r.s4 ?? "-"}</td>
      <td>${r.s5 ?? "-"}</td>
      <td>${r.s6 ?? "-"}</td>
      <td>${r.s7 ?? "-"}</td>
      <td>${r.s8 ?? "-"}</td>
      <td>${r.s9 ?? "-"}</td>
      <td>${r.s10 ?? "-"}</td>

      <td>${r.jumlah_raw ?? "-"}</td>
      <td>${r.sus?.toFixed(1) ?? "-"}</td>
    `;

    tbody.appendChild(tr);
  });
}

/* ==========================================
           POPULATE APP FILTER SUS
========================================== */
function populateSusAppSelect() {
  const sel = document.getElementById("sus-app-select");
  sel.innerHTML = `<option value="">Pilih aplikasi...</option>`;

  const apps = susData.map(x => x.app)
    .filter((v,i,a) => a.indexOf(v) === i)
    .sort();

  apps.forEach(app => {
    const opt = document.createElement("option");
    opt.value = app;
    opt.textContent = app;
    sel.appendChild(opt);
  });
}

/* ==========================================
          FETCH DATA UTAMA
========================================== */
fetch("data.json?" + Date.now())
  .then(r => r.json())
  .then(js => {
    globalData = js;
    renderTable();
    setLastUpdate();
  });

fetch("nim_issues.json?" + Date.now())
  .then(r => r.json())
  .then(js => {
    nimIssues = js;
    renderNimIssues();
  });

fetch("sus_scores.json?" + Date.now())
  .then(r => r.json())
  .then(js => {
    susData = js;
    populateSusAppSelect();
  });

/* ==========================================
          TAB SWITCH
========================================== */
document.getElementById("tab-main").onclick = () => {
  document.getElementById("section-main").classList.remove("hidden");
  document.getElementById("section-sus").classList.add("hidden");

  tab-main.classList?.add("active");
};

document.getElementById("tab-sus").onclick = () => {
  document.getElementById("section-main").classList.add("hidden");
  document.getElementById("section-sus").classList.remove("hidden");
};

/* ==========================================
         Event listeners
========================================== */
document.getElementById("search").oninput = renderTable;
document.getElementById("only-pending").onchange = renderTable;
document.getElementById("filter-app").onchange = renderTable;
document.getElementById("sus-app-select").onchange = renderSusDetail;

</script>

</body>
</html>
